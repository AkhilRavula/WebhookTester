@page "{id:guid}"
@model WebhookTester.Pages.Webhooks.DetailsModel
@{
    ViewData["Title"] = "Webhook Details";
    var isAuthorized = !Model.Webhook.HasPassword || HttpContext.Session.GetString($"Access_{Model.Webhook.Id}") == "true";
}

<div>
    <h4>Webhook Details</h4>
    <hr />
    <dl class="row">
        <dt class="col-sm-2">Webhook URL</dt>
        <dd class="col-sm-10">
            @{
                var url = $"{Request.Scheme}://{Request.Host}/webhook/{Model.Webhook.Id}";
            }
            <div class="input-group mb-3">
                <input type="text" class="form-control" value="@url" readonly id="webhookUrl">
                <button class="btn btn-outline-secondary" type="button" onclick="navigator.clipboard.writeText(document.getElementById('webhookUrl').value)">Copy</button>
            </div>
        </dd>
        <dt class="col-sm-2">Description</dt>
        <dd class="col-sm-10">@Model.Webhook.Description</dd>
        <dt class="col-sm-2">Created At</dt>
        <dd class="col-sm-10">@Model.Webhook.CreatedAt</dd>
    </dl>
</div>

@if (!isAuthorized)
{
    <div class="card">
        <div class="card-header">Password Required</div>
        <div class="card-body">
            <form method="post">
                <div class="mb-3">
                    <label asp-for="Password" class="form-label">Enter Password</label>
                    <input asp-for="Password" type="password" class="form-control" />
                </div>
                @if (Model.ErrorMessage != null)
                {
                    <div class="alert alert-danger">@Model.ErrorMessage</div>
                }
                <button type="submit" class="btn btn-primary">Access</button>
            </form>
        </div>
    </div>
}
else
{
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Requests (@Model.Requests.Count)</h5>
        <div>
            <button class="btn btn-sm btn-info me-2" onclick="requestNotificationPermission()">Enable Notifications</button>
            <a asp-page="./Details" asp-route-id="@Model.Webhook.Id" class="btn btn-sm btn-secondary">Refresh</a>
            <form method="post" asp-page-handler="ClearRequests" asp-route-id="@Model.Webhook.Id" class="d-inline" onsubmit="return confirm('Are you sure you want to delete all requests?');">
                <button type="submit" class="btn btn-sm btn-warning">Clear Requests</button>
            </form>
            <form method="post" asp-page-handler="DeleteWebhook" asp-route-id="@Model.Webhook.Id" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this webhook?');">
                <button type="submit" class="btn btn-sm btn-danger">Delete Webhook</button>
            </form>
        </div>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Time (UTC)</th>
                <th>Method</th>
                <th>Path</th>
                <th>Status</th>
                <th>Body Preview</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var req in Model.Requests)
            {
                <tr>
                    <td>@req.ReceivedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
                    <td>@req.Method</td>
                    <td>@req.Path</td>
                    <td>@req.StatusCodeSentBack</td>
                    <td>
                        @if (req.IsBodyBase64Encoded)
                        {
                            <span class="badge bg-warning text-dark">Binary/Base64</span>
                        }
                        else if (!string.IsNullOrEmpty(req.Body))
                        {
                            @(req.Body.Length > 50 ? req.Body.Substring(0, 50) + "..." : req.Body)
                        }
                    </td>
                    <td>
                        <a asp-page="./Request" asp-route-webhookId="@Model.Webhook.Id" asp-route-requestId="@req.Id">View</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script>
        const webhookId = "@Model.Webhook.Id";
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/webhookHub")
            .build();

        connection.on("ReceiveRequest", function (req) {
            // Add row to table
            const tbody = document.querySelector("table tbody");
            const row = document.createElement("tr");
            row.classList.add("table-success"); // Highlight new row
            
            // Format date
            const date = new Date(req.receivedAt);
            const dateStr = date.toISOString().replace('T', ' ').substring(0, 19);

            row.innerHTML = `
                <td>${dateStr}</td>
                <td>${req.method}</td>
                <td>${req.path}</td>
                <td>${req.statusCodeSentBack}</td>
                <td>${req.body || ''}</td>
                <td><a href="/Webhooks/${webhookId}/Requests/${req.id}">View</a></td>
            `;
            
            tbody.insertBefore(row, tbody.firstChild);

            // Browser Notification
            if (Notification.permission === "granted") {
                new Notification("New Webhook Request", {
                    body: `${req.method} ${req.path}`
                });
            }
        });

        connection.start().then(function () {
            connection.invoke("JoinGroup", webhookId).catch(function (err) {
                return console.error(err.toString());
            });
        }).catch(function (err) {
            return console.error(err.toString());
        });

        function requestNotificationPermission() {
            Notification.requestPermission().then(function (permission) {
                if (permission === "granted") {
                    alert("Notifications enabled!");
                }
            });
        }
    </script>
}
